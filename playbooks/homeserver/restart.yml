---
- name: Check prerequisites
  hosts: localhost
  connection: local
  gather_facts: false
  roles:
    - check_rbw

- name: Restart Docker Containers
  hosts: homeserver
  become: true
  become_user: "{{ user_name }}"

  tasks:
    - name: Ensure docker-manage script is executable
      ansible.builtin.file:
        path: "{{ repo_path }}/scripts/docker-manage.sh"
        mode: '0755'

    - name: Run docker-manage restart
      ansible.builtin.command:
        cmd: "bash {{ repo_path }}/scripts/docker-manage.sh restart"
      args:
        chdir: "{{ repo_path }}"
      environment:
        MY_HOSTNAME: "{{ inventory_hostname }}"
      register: compose_output
      changed_when:
        - "'Restarting' in compose_output.stdout"
