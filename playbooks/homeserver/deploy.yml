---
- name: Deploy Docker Compose Updates
  hosts: homeserver
  become: true
  become_user: "{{ user_name }}"

  tasks:
    - name: Pull latest changes from git
      ansible.builtin.include_role:
        name: git_pull

    - name: Ensure docker-manage script is executable
      ansible.builtin.file:
        path: "{{ repo_path }}/scripts/docker-manage.sh"
        mode: '0755'

    - name: Run docker-manage up
      ansible.builtin.command:
        cmd: "bash {{ repo_path }}/scripts/docker-manage.sh up"
      args:
        chdir: "{{ repo_path }}"
      environment:
        MY_HOSTNAME: "{{ inventory_hostname }}"
      register: compose_output
      changed_when:
        - >-
          'Started' in compose_output.stderr or
          'Recreated' in compose_output.stderr or
          'Created' in compose_output.stderr
