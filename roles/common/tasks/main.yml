---
- name: Install sudo
  ansible.builtin.apt:
    name: sudo
    state: present
    update_cache: true

- name: Gather facts
  ansible.builtin.setup:

- name: Create user {{ user_name }}
  ansible.builtin.user:
    name: "{{ user_name }}"
    password: "{{ user_password | password_hash('sha512') }}"
    shell: /bin/bash
    groups: sudo
    append: true
    create_home: true
    update_password: on_create
    state: present

- name: Set up authorized keys
  ansible.posix.authorized_key:
    user: "{{ user_name }}"
    state: present
    key: "{{ ssh_public_key }}"

- name: Perform apt update and cleanup
  ansible.builtin.include_role:
    name: apt_update

- name: Install essential packages
  ansible.builtin.apt:
    name:
      - ca-certificates  # TLS CA bundle for HTTPS downloads/repos
      - git  # Common VCS dependency for many setups
      - curl  # HTTP client for API calls/downloads
      - wget  # Simple downloader (often used in scripts)
      - vim  # Editor
      - nano  # Editor
      - htop  # Process viewer
      - ncdu  # Disk usage analyzer
      - locales
    state: present

- name: Enable en_US and tr_TR locales
  ansible.builtin.lineinfile:
    path: /etc/locale.gen
    regexp: '^#?\s*{{ item | regex_escape() }}'
    line: "{{ item }}"
  loop:
    - "en_US.UTF-8 UTF-8"
    - "tr_TR.UTF-8 UTF-8"
  notify: Generate locales

- name: Set MY_HOSTNAME environment variable
  ansible.builtin.lineinfile:
    path: /etc/environment
    regexp: '^MY_HOSTNAME='
    line: "MY_HOSTNAME={{ inventory_hostname }}"
